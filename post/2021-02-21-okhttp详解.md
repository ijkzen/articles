---
title: okhttp详解
categories: Android原理
---

## okhttp详解

### 概论

`okhttp`是一个网络库，其功能主要有两点：

1. 请求的发起与响应的接收
2. 多个请求的管理

当前版本为`4.9.0`。

### 请求的发起与响应的接收

这个过程是`U`型的，如[拆轮子系列：拆 OkHttp](https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html)中的流程图所显示的：

![okhttp_full_process](https://cdn.ijkzen.tech/images/2021/02/21/okhttp_full_process.png)

先是向下一步一步地加工报文，到最底端将报文发送到服务端，然后拿到服务器返回的报文后，再向上一步一步将报文转化为开发者指定的数据类型。

#### 请求报文

请求报文分为三个部分：

1. 请求行
2. 请求头
3. 请求体

`请求行`是对该请求的大致描述，`请求头`是对`请求行`的补充以及对`请求体`的约束，`请求体`是客户端想要传递给服务器的数据。
##### 请求行
请求行分为三个部分，每个部分用空格隔开：
1. Http方法，一般为GET、POST、HEAD、PUT、DELETE、OPTIONS、TRACE、CONNECT；
2. 请求目标，就是`url`，例如`https://www.baidu.com`；
3. HTTP版本，例如`HTTP/1.1`

综合一下就是：
```
GET https://www.baidu.com HTTP/1.1
```
##### 请求头
请求头的结构比较简单，以键值对的形式存在，以回车符和换行符隔开，形式如下：
```
Bdpagetype: 2
Bdqid: 0xed9518d40011b00b
Cache-Control: private
Connection: keep-alive
Content-Encoding: gzip
Content-Type: text/html;charset=utf-8
Date: Sun, 21 Feb 2021 13:35:58 GMT
Expires: Sun, 21 Feb 2021 13:35:58 GMT
Server: BWS/1.1
Set-Cookie: BDSVRTM=42; path=/
Set-Cookie: BD_HOME=1; path=/
Set-Cookie: H_PS_PSSID=33425_33506_33403_33344_31253_26350; path=/; domain=.baidu.com
Strict-Transport-Security: max-age=172800
Traceid: 1613914558067414836217119616857332101131
X-Ua-Compatible: IE=Edge,chrome=1
```

##### 请求体
请求体比较灵活，没有固定的格式，可以根据服务的需要自定义格式；
但是有几种常见的格式：
1. Json
```json
{
	"rate": 0.0867625,
	"displayable": true
}
```
服务器可以将这种数据格式转化为对应的数据类；

2. 表单 (application/x-www-form-urlencoded)

```
name=tom&password=1234&realme=tomson
```

3. 二进制表单(multipart/form-data)

```
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="url"

https://www.baidu.com/
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="name"

waffle
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="desk"; filename="桌子.jpg"
Content-Type: image/jpeg

...contents of 桌子.jpg...
```

其中`------WebKitFormBoundary7MA4YWxkTrZu0gW`用于分割不同的字段；

#### 响应报文

响应报文的格式与请求报文的格式十分相似，唯一不同的是响应行不同；

响应头分为三个部分，HTTP版本、状态码和状态码的文本描述；

```
HTTP/1.1 200 OK
```

关于状态码，请看(这篇文章)[https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status]。

#### 拦截器

```kotlin
val interceptors = mutableListOf<Interceptor>()
interceptors += client.interceptors
interceptors += RetryAndFollowUpInterceptor(client)
interceptors += BridgeInterceptor(client.cookieJar)
interceptors += CacheInterceptor(client.cache)
interceptors += ConnectInterceptor
if (!forWebSocket) {
    interceptors += client.networkInterceptors
}
interceptors += CallServerInterceptor(forWebSocket)
```



### 多个请求的管理

## Retrofit详解

### 基本使用

### 原理

